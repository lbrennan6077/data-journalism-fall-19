---
title: "Brennan Final Project"
author: "Leah Brennan"
date: "11/3/2019"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, paged.print=TRUE)
```

## Load Packages

```{r}

#install.packages('tidyverse')
#install.packages('janitor')
#install.packages('tidycensus')
#install.packages('arcos')
#install.packages('corrr')
#install.packages('curl')


library(tidyverse)
library(janitor)
library(tidycensus)
library(arcos)
library(corrr)
library(curl)

# store an API key as an object called key
census_api_key("ee9c9f508567df0be614b71a5c58ebbb21cd991b")
key <- "uO4EK6I"

# Looking up variables:

acs_variables <- load_variables(2017, "acs5" )

county_geodata <- get_acs(geography = "county",
              variables = "B19013_001")
state_geodata <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE)

arcos_county_population_per_year <- county_population(key = key) %>%
  clean_names()

arcos_county_pills_per_year <- summarized_county_annual(key = key) %>%
  clean_names()

```





```{r}

#I'm interested in examining the relationship between income and pills per person rate by tract for Maryland counties. To do so, I examined relationships between these factors for several of counties in the state and compared them.

#I did this for several counties (including Prince George's, Anne Arundel, Carroll, etc.) and have included one of those code blocks, for Baltimore County, to compare with my Harford findings.They all had weak, negative relationships (except for Prince George's, which had a weak, positive relationship). There was no statistically sound relationship in this block, or in any of the counties but Harford. 

BalCo_income_by_tract <- get_acs(geography = "tract", state="MD", county="Baltimore County",
             variables = "B19019_001", geometry = FALSE)
BalCo_tract <- pharm_tracts(county = "Baltimore", state = "MD", key = key)
BalCo_annual_buyer <- combined_buyer_annual(county = "Baltimore County", state = "MD", key = key)

BalCo_combined_buyer_annual <- combined_buyer_annual(county ="Baltimore", state = "MD", key=key)

BalCo_combined_DEA <- BalCo_tract %>%
  inner_join(BalCo_combined_buyer_annual, by = c("BUYER_DEA_NO")) %>%
  group_by(GEOID) %>%
  summarise(total_pills = sum(DOSAGE_UNIT))


BalCo_tract_population <- get_acs(geography = "tract", state="MD", county="Baltimore County",
                            variables =  "B01001_001")

BalCo_population_and_DEA <- BalCo_tract_population %>%
    inner_join(BalCo_combined_DEA, by = c("GEOID")) %>%
  mutate(pills_per_person = total_pills/estimate) %>%
  select(-estimate, -moe) %>%
  inner_join(BalCo_income_by_tract, by = c("GEOID")) %>%
  select(pills_per_person, estimate) 
  
BalCo_population_and_DEA %>%
correlate()

cor.test(BalCo_population_and_DEA$pills_per_person, BalCo_population_and_DEA$estimate, method="pearson")



```


```{r}

#I wanted to compare the counties to the national trend, and there was one. It's a strong negative relationship â€” and it's strong enough to show there is a national trend between income and pill use. 

 national_county_totals <- summarized_county_annual(key=key) %>%
  group_by(countyfips, BUYER_COUNTY, BUYER_STATE) %>%
  summarise(total_pills = sum(DOSAGE_UNIT)) %>%
  inner_join(get_acs(geography = "county", variables = "B01001_001"), by =c("countyfips" = "GEOID")) %>%
  mutate(pills_per_person= total_pills/estimate) %>%
  select(-estimate, -moe) %>%
  inner_join(get_acs(geography = "county", variables = "B19019_001", geometry = FALSE), by =c("countyfips" = "GEOID")) %>%
  ungroup() %>%
  select(estimate, pills_per_person)

national_county_totals %>%
  correlate()

test_r <- cor(national_county_totals$pills_per_person, national_county_totals$estimate)
test_p <- cor.test(national_county_totals$pills_per_person,national_county_totals$estimate)

print(test_r)
print(test_p)



```



```{r}

#Here, I looked for the relationship in Harford County. I found a statistically sound negative relationship here, too. 

HarCo_income_by_tract <- get_acs(geography = "tract", state="MD", county="Harford",
             variables = "B19019_001", geometry = FALSE)
HarCo_tract <- pharm_tracts(county = "Harford", state = "MD", key = key)
HarCo_annual_buyer <- combined_buyer_annual(county = "Harford", state = "MD", key = key)
HarCo_combined_buyer_annual <-combined_buyer_annual(county ="Harford", state = "MD", key=key)

HarCo_combined_DEA <- HarCo_tract %>%
  inner_join(HarCo_combined_buyer_annual, by = c("BUYER_DEA_NO")) %>%
  group_by(GEOID) %>%
  summarise(total_pills = sum(DOSAGE_UNIT))

HarCo_tract_population <- get_acs(geography = "tract", state="MD", county="Harford",
                            variables =  "B01001_001")

HarCo_population_and_DEA <- HarCo_tract_population %>%
    inner_join(HarCo_combined_DEA, by = c("GEOID")) %>%
  mutate(pills_per_person = total_pills/estimate) %>%
  select(-estimate, -moe) %>%
  inner_join(HarCo_income_by_tract, by = c("GEOID")) %>%
  select(pills_per_person, estimate) 
  
HarCo_population_and_DEA %>%
correlate()


cor.test(HarCo_population_and_DEA$pills_per_person, HarCo_population_and_DEA$estimate, method="pearson")

#The p-value is ... actually below 0.05. This relationship is significant! The real question is: why?

```



```{r}
#Just to see if there's a higher amount of pills concentrated with the least finanllly-resourced, I checked for a relationship between pills and poverty level. There was a relationship, but not one that was strong enough to acknowledge.

HarCo_poverty_variable <- get_acs(geography = "tract", state="MD", county="Harford",
                            variables =  "B06012_002")


HarCo_population_and_poverty <- HarCo_tract_population %>%
    inner_join(HarCo_combined_DEA, by = c("GEOID")) %>%
  mutate(pills_per_person = total_pills/estimate) %>%
  select(-estimate, -moe) %>%
  inner_join(HarCo_poverty_variable, by = c("GEOID")) %>%
  select(pills_per_person, estimate) 

HarCo_population_and_poverty %>%
correlate()

#Some kind of positive relationship


cor.test(HarCo_population_and_poverty$pills_per_person,HarCo_population_and_poverty$estimate, method="pearson")

#Cannot reject null

```

```{r}

#So, we have some interesting findings -- there's a strong national relationship between income and pills per person that is reflected in Harford County, but not Baltimore County, city or nearby counties.

```


```{r}

# Now let's see if we can narrow our focus a little more to get further details about Harford County and where it might be good to look as we flesh out our story idea. To do so, let's make a quick dataframe:

HarCo_tract_income <- get_acs(geography = "tract", state="MD", county="Harford", variables = "B19019_001", geometry = FALSE)

HarCo_tract <- pharm_tracts(county = "Harford", state = "MD", key = key)

HarCo_annual_buyer <- combined_buyer_annual(county = "Harford", state = "MD", key = key)

HarCo_tract_data_working <- inner_join(HarCo_annual_buyer, HarCo_tract, by="BUYER_DEA_NO")

HarCo_tract_data_working <- inner_join(HarCo_tract_data_working, HarCo_tract_income, by =c("GEOID"))

HarCo_tract_data_working <- clean_names(HarCo_tract_data_working)

```

```{r}


#How large were the biggest shipments for Harford County?

HarCo_tract_data_working <- HarCo_tract_data_working %>%
  mutate(pills_category = case_when(
         dosage_unit > 10000 ~ "big shipment",
         dosage_unit < 5000 ~ "midsize shipment",
         TRUE ~ "small shipment"))

#The largest shipments were for 18,226 pills to Retail Pharmacy 

#What tract did they go to?

#Tract 3051 claimed the top 18 highest values. There, the average income is $91,447 

```


```{r}

#To continue to get a better sense of the data: What are the annual pill totals per year for Harford County?


HarCo_yearly_pills <- summarized_county_annual(county="Harford", state="MD", key = key)

# In 2006 -- 6988194
# In 2007 -- 7923129
# In 2008 -- 9339780
# In 2009 -- 11143500
# In 2010 -- 11914050
# In 2011 -- 12399790
# In 2012 -- 11416250

#Definitely an increase over time.

```


``` {r}

#In the areas with the most pills in Harford County how high are the incomes?

view(HarCo_tract_income)

#Four highest pill counts were for areas that had incomes over $100K

```

```{r}


#I made a ggplot to visualize the Harford County data a little better.

HarCo_pills_per_person <- arcos_county_pills_per_year %>%
  inner_join(arcos_county_population_per_year, by=c("countyfips","year")) %>%
  mutate(pills_per_person = (dosage_unit/population))
  

HarCo_pills_per_person <- HarCo_pills_per_person %>%
  filter(buyer_county.x == "HARFORD")

  ggplot(HarCo_pills_per_person) +
  geom_bar(stat="identity", aes(year, pills_per_person), fill="royal blue") +
  labs(x="Year", y="Total pills per person", title="Pills steadily raise, peak in 2011 for Harford County", subtitle = "Pills per person rate in Harford County has gone up each year but 2012", caption = "Source: DEA ARCOS database, via Washington Post") +
  scale_x_continuous(breaks = c(2006, 2007, 2008, 2009, 2010, 2011, 2012)) +
  scale_y_continuous()


```


```{r}
#I was curious whether Harford stood out at all with its influx of pills (whether it'd be among the counties with the highest or lowest shipment amounts). I found that Baltimore County had the highest occurrence, but with no similar relationship with income (given, we're also not looking at per person rate right now).


arcos_county_pills_per_year <- summarized_county_annual(key = key) %>%
  clean_names()

maryland_pills_per_year <- arcos_county_pills_per_year %>%
  filter(buyer_state == "MD", (buyer_county %in% c("HARFORD", "BALTIMORE CITY", "BALTIMORE", "CARROLL" , "ANNE ARUNDEL" , "PRINCE GEORGES", "HOWARD"))) %>%
  select(buyer_county, year, dosage_unit)


  ggplot(maryland_pills_per_year) +
  geom_bar(stat="identity", aes(year, dosage_unit, fill=buyer_county)) +
  labs(x="Year", y="Total pills", title="Opioids see more dramatic rise, highest levels in Baltimore County", subtitle = "Total pills per year shipped to several Maryland counties", caption = "Source: DEA ARCOS database, via Washington Post", fill="County") +
  scale_x_continuous(breaks = c(2006, 2007, 2008, 2009, 2010, 2011, 2012)) +
  facet_wrap(nrow=2, . ~ buyer_county) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill="none")
  


```
























