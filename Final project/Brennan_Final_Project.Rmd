---
title: "Brennan Final Project"
author: "Leah Brennan"
date: "11/3/2019"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, paged.print=TRUE)
```

## Load Packages

```{r}

install.packages('tidyverse')
install.packages('janitor')
install.packages('tidycensus')


library(tidyverse)
library(janitor)
library(tidycensus)
library(arcos)

# store an API key as an object called key
census_api_key("ee9c9f508567df0be614b71a5c58ebbb21cd991b")

# Looking up variables:
acs_variables <- load_variables(2017, "acs5" )

county_geodata <- get_acs(geography = "county",
              variables = "B19013_001")
state_geodata <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE)

```

## Load Data


```{r}

baltimore_city <- read_tsv("data/arcos-md-baltimore-city-24510-itemized.tsv")
baltimore_county <- read_tsv("data/arcos-md-baltimore-24005-itemized.tsv")


```

#Observations = rows, variables = columns

## Examine Data


```{r}

View(baltimore_city)
View(baltimore_county)

```

We can also get a sense of the data in a more concise way using the glimpse(function). It's a useful way to examine for flaws: data stored in the wrong format, failure to upload, missing values.

```{r}

#glimpse(baltimore_city)
#glimpse(baltimore_county)

```


```{r}

summary(baltimore_city) 
summary(baltimore_county)

```

## Clean Data

```{r}

baltimore_city <- clean_names(baltimore_city)
baltimore_county <- clean_names(baltimore_county)

glimpse(baltimore_city)
glimpse(baltimore_county)

#pharmacy = buyer, manufacturer = labeler/company

baltimore_city_working <- baltimore_city %>%
  rename(manufacturer_name = combined_labeler_name)

baltimore_county_working <- baltimore_county %>%
  rename(manufacturer_name = combined_labeler_name)

#spaces between some columns and commas between others

baltimore_city_working <- baltimore_city %>%
  select(contains("buyer")) %>%
  unite(buyer_address_complete, buyer_address1, buyer_city, buyer_state, buyer_zip, remove = 'F', sep=" ") 

#I'm putting a space between some columns and a comma between others. 

baltimore_city_working <- baltimore_city %>%
  mutate(buyer_address_complete = paste0(buyer_address1," ", buyer_city, ", ", buyer_state, " ", buyer_zip)) 

#spaces between some columns and commas between others


baltimore_county_working <- baltimore_county %>%
  select(contains("buyer")) %>%
  unite(buyer_address_complete, buyer_address1, buyer_city, buyer_state, buyer_zip, remove = 'F', sep=" ") 

#I'm putting a space between some columns and a comma between others. 

baltimore_county_working <- baltimore_county %>%
  mutate(buyer_address_complete = paste0(buyer_address1," ", buyer_city, ", ", buyer_state, " ", buyer_zip))    



```

## Analyze Data

```{r}

#Question 1

#Which pharmacy location in Baltimore City had the most pills sent to it? How many did it have? 

baltimore_city %>%
  group_by(buyer_name, buyer_address1, buyer_address2) %>%
summarise(pills_per_pharmacy = sum(dosage_unit)) %>%
arrange(desc(pills_per_pharmacy))

#Newcare Home Health Services was the pharmacy location with the most pills sent to it. 6133600 pills. We know this from a previous assignment, but I reran it here to compare with Baltimore County's data.
  

```

```{r}

#Question 2

#Which pharmacy location in Baltimore County had the most pills sent to it? How many pills did it have?

baltimore_county %>%
  group_by(buyer_name, buyer_address1, buyer_address2) %>%
summarise(pills_per_pharmacy = sum(dosage_unit)) %>%
arrange(desc(pills_per_pharmacy))

#Drug City Pharmacy Inc. was the pharmacy location with the most pills sent to it. 16391690 pills. 

#I thought that Baltimore County would have more pills than the city, so right now, my ideas are on track.


```

```{r}

#Question 3

#We actually already have most of the Baltimore City data for the kinds of questions I'm interested in at this point, so I'm going to run some questions on Baltimore County data to compare.

#Which entity had the highest percentage of all pills sent to it in Baltimore County durng the 6-year time frame of ARCOS data?

baltimore_county %>%
  group_by(buyer_name)%>%
summarise(pills_per_pharmacy = sum(dosage_unit)) %>%
  mutate(total_pills =sum(pills_per_pharmacy)) %>%
    mutate(pharmacy_percent_total_pills =(pills_per_pharmacy/total_pills)*100,2)%>%
arrange(desc(pills_per_pharmacy))

#Answer: Maryland CVS Pharmacy, with 1.167459e+01 percent.

```
```{r}

#Question 4

#How do Baltimore City and Baltimore County's dosage units totals compare across the whole time frame?

arcos_county_pills_per_year <- summarized_county_annual(key = key) %>%
  clean_names()

  Baltimore_city_and_county_pills_per_year <- arcos_county_pills_per_year %>%
  filter(buyer_state == "MD", (buyer_county %in% c("BALTIMORE CITY", "BALTIMORE"))) %>%
  select(buyer_county, year, dosage_unit)
  
  # In 2006: Baltimore County -- 21,894,869
  # In 2006: Baltimore city -- 21,249,353
  
  # In 2007: Baltimore County -- 25,347,218
  # In 2007: Baltimore city -- 16,362,494
  
  # In 2008: Baltimore County -- 27,664,210
  # In 2008: Baltimore city -- 17,359,135
  
  # In 2009: Baltimore County -- 31,383,950
  # In 2009: Baltimore city -- 18,172,455
  
  # In 2010: Baltimore County -- 34,224,000
  # In 2010: Baltimore city -- 19,642,120
  
  # In 2011: Baltimore County -- 36,536,397
  # In 2011: Baltimore city -- 20,262,816
    
  # In 2012: Baltimore County -- 35,372,927
  # In 2012: Baltimore city -- 20,673,130
  
  #They appeared on pace in 2006, but when 2007 hits, you see the disparity start, and continue through 2012, with Baltimore City seeing significantly fewer pill totals than the county. Why is that?


```

```{r}

#Question 5

#Which distributor claimed the most pills in Baltimore City over the time span? How many did it have? 

baltimore_city %>%
  group_by(REPORTER_NAME, REPORTER_ADDRESS1, REPORTER_ADDRESS2) %>%
summarise(pills_per_distributor = sum(DOSAGE_UNIT)) %>%
arrange(desc(pills_per_distributor))

#McKesson Drug Company claimed the highest amount of pills with 49,834,830.

```

```{r}

#Question 6

#Which distributor claimed the most pills in Baltimore County over the time span? How many did it have? 

baltimore_county %>%
  group_by(REPORTER_NAME, REPORTER_ADDRESS1, REPORTER_ADDRESS2) %>%
summarise(pills_per_distributor = sum(DOSAGE_UNIT)) %>%
arrange(desc(pills_per_distributor))

#Also McKesson, with 70,552,540 pills. Why is it so much higher?
```

```{r}
# Store a table with the median household income value for each county using the get_acs() function.
county_median_household_income <- get_acs(geography = "county", variables = c("B19013_001"), survey="acs5", year = 2012)

acs_variables <- load_variables(2012, "acs5", cache = TRUE)
# Filter just for Maryland counties
md_county_median_household_income <- county_median_household_income %>%
  filter(str_detect(NAME, ", Maryland"))

white <- get_acs(geography = "county", variables = c("B02001_002"), survey= "acs5", year = 2012, summary_var = "B01001_001")

employment <- get_acs(geography = "county", variables = c("C18120_003"), survey= "acs5", year = 2012, summary_var = "C18120_002")

unemployment <- get_acs(geography = "county", variables = c("C18120_006"), survey= "acs5", year = 2012, summary_var = "C18120_002") %>%
  mutate(unemployment_rate=estimate/summary_est *100)

#total employed labor force= C18120_003
#total labor force unemployed = 	C18120_006

#Unemployment code: B27011_008
#Employment code: B27011_003
#White: B02001_002
#summary_var
# sex by age: B01001_001
#subrract from summary_est for total difference
```

```{r}

#Questions I want to touch on:

#Find pills per person for county and U.S. (demographics, median household)
#scatterplot
#For U.S., 

#1) Which areas in the city have the greatest amounts of pills flowing through? The least?

#2) What’s the income level like in those areas?

#3) What’s the racial breakdown of those areas?

#4) How does the amount of pills compare to the nationwide totals?

#5) What’s the average income in the nation, and how does that relate to the influx of opioids?

#6) What’s the racial breakdown of the nation, and how does that relate to the influx of opioids?

#7) Which pharmacies have the greatest amounts of opioids (in the city, and nationally)? (Repeat for highs/lows for distributors and manufacturers)

#8) Which chains — from manufacturer to buyer to distributor — claim the most opioids locally? How does this compare nationally?


#Bigger, populated urban areas, counties.National, non-white race with per person opioid use. City: pills per person, percentage non-white.

 

county_median_household_income <- get_acs(geography = "county", variables = c("B19013_001"), survey="acs5", year = 2012)

acs_variables <- load_variables(2012, "acs5", cache = TRUE)

# Filtering just for Baltimore City and Baltimore County
#Honestly, not super sure what to do with the census data at this point.
#assign to county for metro categories, per person rate, compare counties
#join RUCC with pills per person by county, join on the #fips
# group by rucc, calculate average
# 9 buckets

 

```


## Submission


```{r include=FALSE}
library(spelling)
spell_check_files("intro_to_r.Rmd")
```
